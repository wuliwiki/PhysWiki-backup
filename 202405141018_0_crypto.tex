% 加密货币简介
% keys 黄金|数字货币|加密货币|虚拟货币|挖矿|矿工|工作证明|持有量证明|算力|双花
% license Xiao
% type Tutor

本文试图在尽量不涉及计算机专业知识的前提下讲解\textbf{加密货币（cryptocurrency）}（也叫\textbf{数字货币}或\textbf{虚拟货币}）的意义和原理。 注意为了方便理解， 一些细节描述并不十分严谨。 本文只从技术上科普加密货币的原理，而这也是区块链技术的原理（我国支持区块链技术的发展）。 本文不构成任何投资建议， 请严格遵守当地法律和规定。

\subsection{黄金}
相对于数字货币，各国政府发行的货币称为\textbf{法定货币}（简称\textbf{法币}）。 法币的出现最早在 1694 年的英国， 在此之前的漫长岁月中， 人类基本在使用一些天然的物质充当货币， 如早期的贝壳， 直到黄金。 直到今天， 黄金仍然承担着货币的角色， 各个国家的国库中依然存有大量的黄金作为法币的信用保证。

黄金能作为等价物是大家的共识， 但注意它没有任何政府背书或发行， 且总量基本固定。 那么它作为货币时， 价值体现在哪里呢？ 简单来说就体现在它的记账功能。 如果直接以商品交换商品， 效率非常低， 因为很难配对到合适的人。 黄金或者一般等价物的使用， 相当于产生了不可篡改账本， 安全地记录每个人所拥有的资源。

黄金使交易更便捷， 从而对古代经济发展起到了重大的助推作用。为什么不能用纸和笔记账？ 因为不安全——陌生人难以辨认真伪， 很可能造假， 也可能被大量增发。 要知道纸币的普及的前提是防伪技术的发展。 可见要让大家都信任一个中立的记账系统， 它必须具有以下特点：
\begin{enumerate}
\item \textbf{安全性}： 不能伪造， 不能被篡改， 不能被发行者大量增发， 不会变质。 黄金在这点上的优势无疑是巨大的， 黄金几乎无法人工合成（只有核反应才能合成极少量）， 金矿勘探和开采的难度非常大， 在自然条件下可以稳定存放。 但有一个缺点就是鉴别真伪成本较高， 需要彻底熔化或者使用现代仪器。
\item \textbf{便携}： 由于黄金总量相对较少， 所以用作货币单价很高， 只需携带少量即可满足日常需求。 但这比起当代电子设备还是不够方便。
\item \textbf{转账方便}： 黄金交易在古代的确是算非常方便， 但在比起比起电子转账同样差很多。
\end{enumerate}

综上，黄金的价值就在于它利用其出色的物理特性， 在历史上相当长的时间里充当账本的角色， 极大地促进了人类社会的早期发展。 需要指出的是黄金这个 “账本” 只记录每人的余额而不计录转账历史， 这是又一缺点。

在互联网高度发达的今天， 我们是否可以在互联网上建立一个像黄金一样的数字账本呢？ 只要把以上三点实现得更好， 它就可能具有比黄金更大的潜在价值。 这看起来容易， 实则非常困难， 要付出巨大的代价。 困难的根源在于，互联网不能储存类似黄金的实物而只能储存数据，而数据是可以完美复制的。 如果用一段数据代表一定价值的数字货币，那么其拥有者就可以把它完美复制任意多份而任何人都无法辨别哪些是复制品，所以这种幼稚的方法注定是行不通的。

\subsection{中心化记账系统}
在了解什么是去中心化之前，你需要先了解一个中心化的记账系统是如何运作的。我们以支付宝为例，为了简单起见我们假设支付宝只有一台服务器，也就是所谓的中心服务器。 服务器并没有什么神秘之处，你可以想象支付宝公司给一台性能很高容量很大的电脑接了一根网线，它有一个固定的网址，互联网上其他电脑都可以通过这个网址跟这台电脑通信。 这个中心服务器上面存了一个账本，你可以认为它是一个巨大的 excel 表格， 存在服务器的硬盘中。 这个表格具有从支付宝成立以来的所有账户的转账记录。

一开始这个账本当然是空的，第一个客户注册了以后，给了支付宝一笔现金，支付宝把这笔钱放到公司的保险柜里面，并在表格中给该用户增加了一笔收入。接下来的事情不必多说，任何用户拿着现金来给支付宝充值时，支付宝都如法炮制即可。 当用户需要检查自己的账户余额时，他在任何有互联网的地方只要用设备浏览器输入支付宝的网址，这个设备就会向支付宝公司的那台电脑（服务器）发送一个请求，服务器返回一个登录页面，用户提供账号密码，服务器再返回用户主页……接下来的流程相信无需多言了。 要注意的是，任何信息都以储存在唯一一台服务器中的唯一一个账本为准（当然会有备份，但这跟我们的讨论无关），无论用户是通过浏览器网页登录，还是安装了客户端（我们以下都统称为客户端），它们都会向服务器索取信息，并\textbf{无条件相信服务器返回的数据}并显示给用户。

现在来看转账的过程。 当用户 A 在客户端确认了自己的余额后，他给 B 发起了 100 元的转账。 这时千万不要认为 A 的手机直接连接到 B 的手机把某种代表 100 元的编号传了过去。 实际的过程是， A 在连接到服务器并登录后， 服务器通过密码确认了 A 的身份， 保持连接。 然后 A 向服务器发起一个向 B 转 100 元的请求。 服务器接收到该请求， 在那个叫做账本的巨大 excel 表格中，给 A 的页面添加了一个向 B 转账 100 元的记录，再给 B 的页面添加一个收到 A 的 100 元记录。 注意这仅仅是服务器根据其程序自动完成的一个文件读写操作，并不需要对宝保险柜里面的钱进行任何操作。 事实上所有用户的钱都可以随意混合到保险柜中，完全不需要区分哪些钱是那个用户的，用户取钱的时候也不需要归还他原本充值时的那几张钱。

为什么说这个记账系统是中心化的呢？ 虽然每笔转账的过程都涉及不同的连入互联网的设备，但这些设备的角色是不平等的。唯一的一台服务器具有绝对的话语权，保存了\textbf{全网唯一}一个完整的账本，其他所有的设备都只是充当客户端的角色，不可能具有和服务器同样的功能。 所以如果你懂技术，用某种手段修改了自己手机上面的支付宝程序，每天给自己手机上离线储存的余额添加一笔巨款，但这并不会得到中心服务器的承认，当你请求服务器转出这些巨款的时候，服务器会根据它硬盘中的表格判断，你的余额不足以支付这笔巨款，并返回一个错误。

但支付宝服务器中的表格就永远铁面无私吗？别忘记服务器只是一台电脑而已，拥有它的人可以对它的数据进行任意修改。当然这只是从技术的角度而言，请勿与实际挂钩。 为了对下文加密货币的挖矿做铺垫，我们不妨假设支付宝公司推出了一个每天打卡领红包的活动。 于是负责客户端的程序员在下一个版本的客户端程序中添加了一个打卡按钮，而负责服务器程序员开发的程序员也更新了服务器上的程序。 这样每次用户登录并按下打卡按钮，客户端就会发送一个打卡请求给服务器，而服务器在确认用户的确是今日第一次打卡后，在自己的中心账本上给用户记上一笔打卡收入，注意这笔收入并没有从任何其他账户中扣去同样的余额，所以并不是一个转账，而是程序\textbf{凭空产生的}。 这样一来，服务器账本上所有账户的总余额，将比保险柜中的现金要多了。但这并不要紧，因为几乎不可能出现所有的用户都在同一时间要求把自己的所有余额兑换成现金的情况。 如果为了保险起见，支付宝也可以选择把公司在其他方面的一些盈利放入保险柜，使得其中的总额等于账本的总额，但这与我们的讨论没有太大关系。

由此可见，仅从技术角度而言，支付宝有能力改变服务器中的一切数据和规则，而所有的客户端只能服从，即使有人开发了一个不听话的客户端也无所谓，服务器并不会参考该客户端的数据。注意现实中除了技术，还有相关法律和制度的约束，例如相关部门会对他们的账本和保险柜进行定期审查。

\subsection{去中心化账本和加密货币}
现在我们知道\textbf{互联网上的许多数据都储存在服务器中}，服务器就是互联网上用于提供信息服务的计算机，通常放在专门的机房中昼夜连续运行。例如当你访问某个网站或玩某个网游时，你的电脑接收到的数据就是对应的服务器发送的。 我们的网银， 支付软件， 游戏币， 充值卡等， 本质上是政府或者公司发行的， 可以称为\textbf{中心化账本}。 这些账本的数据保存在政府（或公司）所拥有的服务器中。单从技术上来说，服务器的所有者对数据有绝对的控制权， 可以对其进行任意修改甚至删除。 所以保障你支付软件中余额不被服务器拥有者任意修改的，是法律而不是技术。 另外一旦出现服务器被黑客攻击、公司破产等情况发生， 他们发行的数字代币也可能得不到保障（虽然可能性较小）。

另一方面， 政府为了刺激经济会经常增发货币， 但也有可能导致通货膨胀。 例如美国在 2020-2021 年因新冠疫情大量增发美元使其他国家的美元储备贬值（实际上他们并不需要印刷同样数量的纸钞，他们只需要在中央银行的服务器中更改数据即可）。 另外货币的发行者有能力冻结或没收账户中的财产， 或者控制它与其他币种之间的兑换。 所以只从以上黄金的第 1 个特点来看， 所有被政府或公司控制的中心化数字记账方式都远不如黄金。 所以即使第 2 和第 3 点做得再好也还是有缺憾。

那么创造数字黄金的难点就在于如何使一个基于互联网的记账系统，使其像黄金一样不受任何组织的控制， 即\textbf{去中心化（decentralize）}。 只有这样才可能使第 1 点的安全性能和黄金媲美。 这就要求储存该账本的服务器不完全受单个机构控制，即单个机构无法篡改（或毁灭）该网络账本，更无法篡改记账服务器的程序。

直到\textbf{中本聪（Satoshi Nakamoto）}（化名）在 2009 年提出区块链的概念并发行了\textbf{比特币（bitcoin）}后， 这种机制才慢慢完善。 比特币网络是一个\textbf{去中心化（decentralized）}的网络账本， 具体来说就是说比特币完整账本的数据同时储存在许多不同的服务器中，这些服务器由不同的人或机构拥有，且服务器的地位都是等价的，没有哪个服务器具有控制其他服务器数据的权限。 任何人或机构都可以购买自己的服务器，安装相应的记账程序并接入互联网， 共同完成记账（当然，他也可能安装一个自己篡改后的恶意程序并接入网络，下面我们会详细讨论）。 账本在每个服务器中都有一个完整的备份， 这包含比特币账本有史以来每一个账号发生的每一笔交易记录， 根据这些交易记录可以计算得到每个账户的余额。 服务器之间会根据程序互相确认账本的一致性， 若有不同则以多数一致为准\footnote{“以多数一致为准” 并不完全准确，但在学习更多概念以前你可以暂时这么理解。实际上比特币是以最长的区块链为准。}。 这样一来，虽然每台服务器都有具体的所有者，虽然所有者可以任意篡改这台服务器的数据（例如给自己的账户凭空增加一笔巨额），但篡改后的数据并不会得到其他服务器的认可，也就无法生效，其他正常的服务器将会无视该服务器的数据，拒绝与其通讯。

\subsection{如何转账}
比特币允许任何人匿名生成任意多个账户， 无需提供任何身份信息。事实上，这些账户是离线生成的，无需联网注册。 每个账户都有一个独特且\textbf{公开}的\textbf{地址}（一长串字母和数字）， 以及与之匹配的密码（一长串字母和数字）， 称为\textbf{私钥（private key）}，正常情况下私钥只有账户的持有者知道，任何其他用户以及任何服务器都不可能知道。 转账的操作和常用支付软件类似，也是通过电脑和手机上的客户端操作。 从客户端的底层原理上来说，转账者的客户端需要生成一段转账请求的数据，其中包含要转账的地址，接收转账的地址，转账的金额，以及其他一些信息（例如时间、手续费等），并\textbf{用私钥对该转账请求进行签名}（签名本身也是一小段数据）。 签名后该转账请求通过互联网被广播到多个比特币服务器， 注意广播的数据中并不包含私钥，仅包含转账的明文信息和签名。 注意转账信息本身是不加密的。

当服务器收到广播后，虽然服务器并不知道转账者的私钥， 但是可以轻易地\textbf{验证转账请求中的签名是否和转账信息匹配}。如果通过匹配，就说明该转账的确是由私钥持有者发起的。 验证以后，转账信息将可能被写入区块链（也就是账本）并广播到其他所有服务器。 只有取得大部分比特币服务器的\textbf{共识（concensus）}， 确认一致后这笔转账才算正式生效。

签名和验证签名的具体原理涉及到密码学中的\textbf{非对称加密}， 超出了本文范围。 你暂时只需要知道非对称加密的几个结论即可：
\begin{enumerate}
\item 只有私钥的拥有者可以给转账信息正确签名
\item 任何人都可以验证该签名的真实性（即签名和转账信息匹配\footnote{想象一下如果有一个不诚实的服务器在收到你的转账请求以后篡改了接收转账的地址或其他任何信息，那么这将导致转账信息和私钥变得无法匹配，当它把该信息广播给其他服务器时，其他服务器将会拒绝将转账信息写入账本。}），无需拥有私钥
\item 无法通过签名还原出私钥
\end{enumerate}
这三条定律是比特币安全性的基石，它们由密码学保障，算法完全公开，且被广泛用于金融、军事等各种重要领域。 如果有人能破解非对称加密，那么互联网上大多数加密安全措施将同样对他无效。

所以要确保你的比特币真正属于你，就要确保\textbf{有且只有}你拥有其所在地址的私钥。 如果有人要给你比特币，千万不可以直接向他索取私钥而是要通过上述的转账流程。因为对方完全可以事先把私钥备份，导致接下来你和他都可以随时将该地址中的比特币转走。 谁先这么做，谁就会成为这些比特币唯一拥有者。

%\addTODO{举例！ 画 4 台电脑， 四个人互相连接。 若有一些人转账， 向所有人广播， 一起记账并对账。 若其中有一个人不一致， 那么其他三个不采用他的账本。 但若不诚实的人另外买了 5 台电脑， 那么别人就以为他是对的。}

\subsection{用户隐私}
由于任何人都可以搭建比特币服务器参与记账， \textbf{所有转账记录都是公开的}。 那么用户隐私如何保障？ 隐私的关键在于地址的匿名性：虽然任何人都可以查到任何地址的所有转账信息，但却无法直接知道谁拥有该地址。 任何人都可以生成任意多个地址， 甚至每笔交易都可以使用一个不同的地址， 所以用户的隐私仍然可以得到一定程度保障。 更多细节我们将在 “\enref{使用数字货币钱包}{CryWal}” 中具体介绍。

为什么说比特币的隐私保障只是\textbf{一定程度}上的呢？我们设想如果一个商店在自己的官方网站上公布了一个\textbf{固定不变的}比特币收款地址，那么该地址的所有者就成为了公开信息。 此时查询该地址的所有转账信息，就可以知道该商店的营收情况\footnote{正因如此，很少会有收款方使用固定的地址收款，一般是每笔交易使用一个新的收款地址。}，以及哪些地址经常在该商店购买商品，那么就可以大致确定这些地址所有者的地理位置。 若通过大数据的方法将许多公开身份的地址进行交叉对比，就有可能十分精确地锁定一些原本匿名的地址的所有者范围。另外，如果一个地址的所有者在交易所有实名账号（大部分正规交易所需要实名注册）且进行过转账（例如使用加密货币兑换法币或反之），那么交易所就可以轻易把地址和实名信息一起记录下来。

如果比特币被用于非法交易，执法机构是有可能追溯到地址持有者的（注意执法者不可能冻结该地址）。 例如不法分子通过制作电脑的勒索病毒收取比特币作为赎金， 那么执法机构可以首先把收款地址列入黑名单，对其实施严格监控，一旦其中的比特币被转出到其他地址，那么这些账号也会进而被监控。如果这些比特币最终流入的任意账号的持有者暴露身份（例如试图通过交易所兑换法币），执法机构就可以对其进行抓捕审查等。所以这样的非法地址的持有者要想把比特币兑换成法币是有一定难度的（例如通过混币机制或私下交易，我们先不深究）。

正因如此，当你在接收他人的比特币时，尤其是有人想私下用他的比特币换取你的法币时，请务必确认对方的可信度以及留下关于对方尽可能多的信息。 如果对方给你转账的比特币来源是非法的，那么你将可能遇到麻烦（届时你将需要证明你对此并不知情）。 注意这并不是加密货币特有的问题，接收非法来源的法币也有同样风险。

\subsection{安全性的代价}
既然任何人都可以参与到比特币网络中， 那么将其恶意破坏也会变得比中心化网络更容易。 对于中心化服务器， 控制者只需要给服务器设置一个密码就可以防止被黑客入侵， 而如果有人要恶意破坏比特币网络， 他只需要购买大量服务器， 在网络中的数量达到多数就可以通过所谓的 “共识” 来做假账， 例如花一笔比特币然后事后抹掉记录再花一次（即\textbf{双花， double spending}）\footnote{但他仍然不能把其他任意账户中的钱转给自己， 因为他没有其他账户的密钥，无法生成正确签名。}。 所以为了提高账本的安全性， 我们必须使得 “买下大部分服务器” 变得异常艰难。 即大大提高每台服务器所需的成本。 比特币网络的做法就是把记账权和服务器的\textbf{算力}（计算能力）挂钩， 每台服务器必须完成一些很难（但没有意义）的数学题才能获取更多的记账权， 这些题的答案很难被算出， 但算出后很容易验证正确性。 理想状况下是整个网络的总算力极高， 且服务器的所有者非常分散， 使得少部分人或机构几乎不可能取得该网络的控制权从而对数据进行恶意篡改。 这些无意义的计算最终会消耗大量资源， 但这却是维持比特币安全性的必要代价。 在 2016 年， 据估计比特币网络的总算力已经达到世界前 500 的超级计算机集群的总和。 这使得比特币比其他的货币更为安全。 根据公开信息，至今只发生过一次比特币本身被 “破解” 的案例\footnote{这是由于早期比特币程序的一个 bug 导致，后来马上被修复。}。 我们在新闻中看到的一些交易所被黑客攻击导致用户比特币丢失的情况，并不属于比特币本身被破解，而是交易所中用于储存私钥的服务器被破解，黑客盗取了这些私钥，从而把对应地址中的比特币转移。要避免这种风险，用户只需在交易所购买加密货币后，将其转到自己的私人钱包即可。但是此时私人钱包的密钥被盗就成为了另一种风险，详见\enref{使用数字货币钱包}{CryWal}。

在另一些加密货币中， 为了不过多消能源和硬件， 也有采用把服务器所有者的加密货币余额作为比重获取记账权。 比特币的方法叫做\textbf{工作证明（proof of power）}， 后者叫做\textbf{持有量证明（proof of stake）}。 另一种较新的方式是\textbf{储存空间和时间证明（proof of space and time）}， 也就是所谓的硬盘挖矿。 但无论如何， 为了使网络具有安全性， 网络中的服务器必须以某种珍贵的资源作为记账权的分配标准， 且这种资源需要容易证明且无法造假。

\subsection{挖矿}
既然比特币服务器需要那么多资源， 为什么还有人愿意搭建呢？ 为了补偿这些维护比特币网络安全性的服务器所有者， 比特币协议规定每十分钟左右就会对成功解出数学题并获得记账权的账户进行奖励， 所以人们就形象地把提供服务器算力并获取奖励的行为称为\textbf{挖矿（mining）}， 挖矿的人称为\textbf{矿工（miner）\footnote{miner 也可以指挖矿所用的软件。}}。 而所有的比特币都是通过挖矿产生的。 比特币协议规定大约每 4 年挖矿的收益就会减半， 从而使其总量存在上限（2100 万枚）。 除了挖矿获得奖励外， 矿工还会获得一些转账手续费， 手续费在用户转账时从支付的一方转到矿工的地址中。 当所有比特币都被挖完后， 理想情况下此时比特币的价格已经昂贵到足以让转账手续费支持所有矿工的开支， 这样该系统就能自给自足地一直运行下去。

\addTODO{协议或代码如何更新？ 硬分叉是什么？ 既然代码开源，人人都可以发行新币，为什么它还有价值？为什么比特币记账那么慢？什么是不可能三角？}
