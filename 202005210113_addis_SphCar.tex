%球坐标与直角坐标的转换
% 坐标系|球坐标系|直角坐标系|矢量

\pentry{球坐标系的定义\upref{Sph}， 四象限 Arctan 函数\upref{Arctan}}

根据球坐标的定义，可得两种坐标之间的变换关系
\begin{equation}\label{SphCar_eq1}
\begin{cases}
x = r\sin \theta \cos \phi \\
y = r\sin \theta \sin \phi \\
z = r\cos \theta 
\end{cases}
\end{equation}
\begin{equation}\label{SphCar_eq2}
\leftgroup{
r &= \sqrt {x^2 + y^2 + z^2} \\
\theta  &= \arccos\qty(z/\sqrt{x^2 + y^2 + z^2})\\
\phi  &= \Arctan(y, x)
}\end{equation}
其中 $\Arctan$ 函数的定义见\autoref{Arctan_eq1}\upref{Arctan}． 注意

\subsection{矢量的变换}
两组基底之间的变换关系为
\begin{equation}\label{SphCar_eq3}
\begin{cases}
\uvec r = R_{11}\uvec x + R_{12}\uvec y + R_{13}\uvec z\\
\uvec \theta = R_{21}\uvec x + R_{22}\uvec y + R_{23}\uvec z\\
\uvec \phi = R_{31}\uvec x + R_{32}\uvec y + R_{33}\uvec z
\end{cases}
\end{equation}
\begin{equation}\label{SphCar_eq4}
\begin{cases}
\uvec x = R_{11} \uvec r + R_{21} \uvec \theta  + R_{31} \uvec \phi \\
\uvec y = R_{12} \uvec r + R_{22} \uvec \theta  + R_{32} \uvec \phi \\
\uvec z = R_{13} \uvec r + R_{23} \uvec \theta  + R_{33} \uvec \phi
\end{cases}
\end{equation}
其中 $\mat R$ 是三维旋转矩阵\upref{Rot3D}
\begin{equation}\label{SphCar_eq5}
\mat R = \pmat{
    \sin\theta\cos\phi & \sin\theta\sin\phi & \cos\theta\\
    \cos\theta\cos\phi & \cos\theta\sin\phi & -\sin\theta\\
    -\sin\phi & \cos\phi & 0
}
\end{equation}

若任意矢量 $\bvec v$ 在直角坐标系和球坐标系中分别表示为
\begin{equation}\label{SphCar_eq7}
\bvec v = v_x \uvec x + v_y \uvec y + v_z \uvec z
\end{equation}
\begin{equation}\label{SphCar_eq6}
\bvec v = v_r \uvec r + v_\theta \uvec \theta + v_\phi \uvec \phi
\end{equation}
则坐标变换关系可以用矩阵乘法表示
\begin{equation}\label{SphCar_eq9}
\pmat{v_r \\ v_\theta \\ v_\phi}
= \mat R \pmat{v_x \\ v_y \\ v_z}
\end{equation}
\begin{equation}\label{SphCar_eq8}
\pmat{v_x \\ v_y \\ v_z}
= \mat R\Tr \pmat{v_r \\ v_\theta \\ v_\phi}
\end{equation}

\subsection{推导}
把空间中一点 $P$ 的位矢 $r \,\uvec r$ 分解为垂直于 $xy$ 平面的分量 $z = r\cos \theta $ 和 $xy$ 平面的分量 $r\sin \theta $． 后者又可以进而分解成 $x$ 分量 和 $y$ 分量  $x = r\sin \theta \cos \phi$，  $y = r\sin \theta \sin \phi$， 这就得到了\autoref{SphCar_eq1}．

在直角坐标系中， 有 $r = \sqrt {x^2 + y^2 + z^2}$， 代入\autoref{SphCar_eq1} 中的三条关系，就可以很容易解出\autoref{SphCar_eq2} 中的三条关系．

现在推导变换关系（\autoref{SphCar_eq3}）．由于 $\uvec r,\uvec \theta ,\uvec \phi $ 都是关于 $(r, \theta, \phi)$ 的函数，所以在考察一点 $(r, \theta, \phi)$ 时， $\uvec r$ 的球坐标是 $(1, \theta, \phi)$，  根据\autoref{SphCar_eq1} 变换到直角坐标为
\begin{equation}
(\sin \theta \cos \phi,\,\sin \theta \sin \phi,\,\cos \theta)
\end{equation}
写成矢量的形式，就是
 \begin{equation}
\uvec r = \sin \theta \cos \phi \,\uvec x + \sin \theta \sin \phi \,\uvec y + \cos \theta \,\uvec z
\end{equation}
至于\autoref{SphCar_eq3} 的第二条式子，在同一个球坐标 $(r,\theta ,\phi)$ 处， $\uvec \theta $ 的球坐标为 $(1, \theta + \pi /2, \phi)$， 根据\autoref{SphCar_eq1} 变换到直角坐标再化简就得到直角坐标和对应的矢量形式为
\begin{equation}
(\cos \theta \cos \phi ,\,\cos \theta \sin \phi , \,- \sin \theta)
\end{equation}
\begin{equation}
\uvec \theta  = \cos \theta \cos \phi \,\uvec x + \cos \theta \sin \phi \,\uvec y - \sin \theta \,\uvec z
\end{equation}
同理可得\autoref{SphCar_eq5}． 将基底变换\autoref{SphCar_eq3} 和\autoref{SphCar_eq4} 分别带入\autoref{SphCar_eq6} 和\autoref{SphCar_eq7} 得坐标变换\autoref{SphCar_eq8} 和\autoref{SphCar_eq9}．
